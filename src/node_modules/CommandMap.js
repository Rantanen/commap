
/*global $, L */
"use strict";

var MapMarker = require('MapMarker');
var EditControls = require('EditControls');
var ContinentLayer = require('ContinentLayer');

var CommandMap = function( model, game ) {
    this.model = model;
    this.game = game;

    // Create the map.
    $('#map').remove();
    var mapElement = $('<div id="map">');
    $('#map-container').append( mapElement );
    this.map = L.map('map', {
        minZoom: 0,
        maxZoom: 5,
        crs: game.getCRS(),
        zoomControl: false,
        maxBounds: L.latLngBounds([ -0.5, -0.5 ], [ 1.5, 1.5 ])
    }).setView([0.5,0.5], 3);
    this.layerControls = L.control.layers( {}, {}, { collapsed: false } ).addTo( this.map );
    var controlDom = $( this.layerControls._container );
    var toolbar = $('<div class="toolbar" />').append(
        $('<div class="toolbar-top-right">'),
        $('<div class="toolbar-middle">'),
        $('<div class="toolbar-bottom">')
    );

    controlDom.replaceWith( toolbar );
    toolbar.append( controlDom );


    this.map.on( 'mousemove', function(e) {
        $('#map-coordinates').text(
            e.latlng.lat + ", " + e.latlng.lng
        );
    });

    // Initialize the members.
    this.playerOverlays = {};
    this.markers = {};

    var self = this;
    this.model.on( 'playerupdated', function( player ) { self.updatePlayer( player ); } );
    this.model.on( 'playerremoved', function( player ) { self.removePlayer( player ); } );
    this.model.on( 'markerupdated', function( marker ) { self.updateMarker( marker ); } );
    this.model.on( 'markerremoved', function( marker ) { self.removeMarker( marker.player, marker.id ); } );
};

CommandMap.prototype.setPlayer = function( player, server ) {
    this.player = player;
    this.server = server;

    if( player ) {
        // Create and add edit controls.
        if( !this.editControls ) {
            this.editControls = new EditControls( this ).addTo( this.map );
        } else {
            this.editControls.update();
        }

        this.updatePlayer( player );
    } else {
        this.map.removeControl( this.editControls );
        this.editControls = null;
    }

    for( var i in this.markers ) {
        var marker = this.markers[ i ];
        marker.setCanInteract( player !== null );
    }
};

CommandMap.prototype.changeContinent = function( continent ) {
    this.continent = continent;
    var i;

    if( this.continentLayer ) {
        this.map.removeLayer( this.continentLayer );
    }

    this.continentLayer = new ContinentLayer( continent, this.game );
    this.map.addLayer( this.continentLayer, true );

    // Clear the current marker data.
    for( i in this.playerOverlays ) { this.playerOverlays[ i ].clearLayers(); }
    this.markers = {};

    for( i in this.model.data.players ) {
        var player = this.model.data.players[i];
        this.updatePlayer( player );
    }
};

CommandMap.prototype.updatePlayer = function( player ) {
    var self = this;
    var overlay = null;
    var updateMarker = {};

    if( this.playerOverlays[ player.id ] ) {
        overlay = this.playerOverlays[ player.id ];
        overlay.eachLayer( function( marker ) {
            if( !player.markers[ marker.id ] || player.markers[ marker.id ].continent !== this.continent ) {
                delete self.markers[ marker.id ];
                overlay.removeLayer( marker );
            }
        });
    }

    if( !overlay ) {
        overlay = L.layerGroup().addTo( this.map );
        if( this.player !== player ) {
            this.layerControls.addOverlay( overlay, player.info.name );
        }
        this.playerOverlays[ player.id ] = overlay;
    } else {
        if( this.player === player ) {
            this.layerControls.removeLayer( overlay );
        }
    }

    for( var m in player.markers ) {
        this.updateMarker( player.markers[ m ] );
    }
};

CommandMap.prototype.removePlayer = function( player ){
    var self = this;
    if( this.playerOverlays[ player.id ] ) {
        var overlay = this.playerOverlays[ player.id ];
        overlay.eachLayer( function( marker ) {
            delete self.markers[ marker.id ];
        });
        this.layerControls.removeLayer( overlay );
        this.map.removeLayer( overlay );
        delete this.playerOverlays[ player.id ];
    }
};

CommandMap.prototype.updateMarker = function( model ) {

    // If this marker doesn't belong to the current continent, abort.
    if( model.continent !== this.continent ) { return; }

    var self = this;
    model.mine = ( this.player && model.player === this.player.id );

    var layer = this.playerOverlays[ model.player ];
    if( !layer ) { return; }

    var marker = null;
    if( this.markers[ model.id ] ) {

        marker = this.markers[ model.id ];
        marker.update( model );

    } else {

        marker = new MapMarker( model, !!this.player ).addTo( layer );
        marker.on('remove', function ( model ) { self.onRemoveMarker( model ); } );
        marker.on('moved', function ( data ) { self.server.updateMarker( data.model ); });
        marker.on('addTarget', function ( data ) { self.onAddTarget( data.model, data.location ); });
        marker.on('rejectSuggestion', function ( data ) { self.server.rejectSuggestion( data.model.id, data.player ); });
        this.markers[ model.id ] = marker;
    }
};

CommandMap.prototype.onUpdateMarker = function( marker ) {
    this.model.updateMarker( marker );
    this.server.updateMarker( marker );
};

CommandMap.prototype.onRemoveMarker = function( marker ) {
    this.server.removeMarker( marker.player, marker.id );
    this.model.removeMarker( marker.player, marker.id );
};

CommandMap.prototype.onAddTarget = function( marker, target ) {
    if( !marker.unique || marker.mine ) {
        marker.target = target;
        this.server.updateMarker( marker );
        this.model.updateMarker( marker );
    } else {
        this.suggestTarget( marker.id, target, this.player.info.name );
        this.server.suggestTarget( marker.id, target );
    }
};

CommandMap.prototype.onDraw = function( start, end ) {
    this.server.draw( start, end );
    this.draw( start, end );
};

CommandMap.prototype.suggestTarget = function( markerId, target, playerName ) {
    var marker = this.markers[ markerId ];
    if( !marker ) { return; }

    marker.suggestTarget( target, playerName );
};

CommandMap.prototype.rejectSuggestion = function( markerId, playerName ) {
    var marker = this.markers[ markerId ];
    if( !marker ) { return; }
    marker.removeSuggestion( playerName );
};

CommandMap.prototype.draw = function( start, end ) {
    var self = this;
    var polyline = L.polyline([ start, end ], { color: 'red', opacity: 1 }).addTo( this.map );
    setTimeout( function () {
        var opacity = 1;
        var interval = setInterval( function () {
            opacity = opacity - 0.25;
            if( opacity <= 0 ) {
                clearInterval( interval );
                self.map.removeLayer( polyline );
            } else {
                polyline.setStyle({ opacity: opacity });
            }
        }, 100 );
    }, 5000);
};

CommandMap.prototype.removeMarker = function( owner, id ) {
    var marker = this.markers[ id ];
    var layer = this.playerOverlays[ owner ];
    layer.removeLayer( marker );
    delete this.markers[ id ];
};

module.exports = CommandMap;
