
/*global L, $, prompt */
"use strict";

var MarkerModel = require('MarkerModel');

var EditControls = L.Control.extend({
    options: {
        position: 'topleft'
    },

    initialize: function ( map ) {
        this.tools = [];
        this.map = map;
    },

    update: function () {
        this.defaultPlatoon.setIcon( this.map.player.info.outfit.icon );
    },

    onAdd: function () {
        this.toolsContainer = L.DomUtil.create( 'div', 'map-controls' );
        var self = this;

        var marker_tools = [
            {
                id: 'place_terran',
                label: 'Terran',
                img: 'tr.png'
            },
            {
                id: 'place_nc',
                label: 'NC',
                img: 'nc.png'
            },
            {
                id: 'place_vanu',
                label: 'Vanu',
                img: 'vs.png'
            }
        ];

        self._addTool( self._createToolBase({ id: 'pan', label: 'Pan', img: 'pan.png' }) );

        $.each( marker_tools, function( k, spec ) {
            var tool = self._createMarkerTool( spec );
            self._addTool( tool );
        });

        var newPlatoonTool = self._createToolBase({ id: 'add_platoon', label: 'New platoon', img: 'default.png' });
        newPlatoonTool.activate = function () {
            var name = prompt("Platoon name");
            if( name ) {
                var platoonTool = self._createPlatoonControl( name );
                self.activateTool( platoonTool.id );
                this.toolsContainer.append( newPlatoonTool.button );
            } else {
                self.activateTool( 'pan' );
            }
        };

        this.defaultPlatoon = this._createPlatoonControl( this.map.player.info.name );
        // self._addTool( newPlatoonTool );

        var penTool = self._createToolBase({ id: 'pen', label: 'Pen', img: 'pen.png' });
        penTool.activate = function () {
            self.map.map.dragging.disable();
            self.map.map.on( 'mousedown', pen_down );
        };

        penTool.deactivate = function () {
            self.map.map.dragging.enable();
            self.map.map.off( 'mousedown', pen_down );
            self.map.map.off( 'mouseup', pen_up );
            self.map.map.off( 'mouseup', pen_track );
        };

        var penInterval = null;
        var pen_down = function (e) {
            console.log( "Pen down" );
            penTool.previous = e.latlng;
            penTool.next = e.latlng;
            self.map.map.off( 'mousedown', pen_down );
            self.map.map.on( 'mouseup', pen_up );
            self.map.map.on( 'mousemove', pen_track );
            penInterval = setInterval( pen_send, 20 );
        };

        var pen_track = function (e) {
            penTool.next = e.latlng;
        };

        var pen_up = function (e) {
            console.log( "Pen up" );
            self.map.map.on( 'mousedown', pen_down );
            self.map.map.off( 'mouseup', pen_up );
            self.map.map.off( 'mouseup', pen_track );
            clearInterval( penInterval );
        };

        var pen_send = function (e) {
            if( penTool.next.lat === penTool.previous.lat &&
                penTool.next.lng === penTool.previous.lng ) {
                return;
            }

            console.log( "Drawing segment" );
            self.map.onDraw( penTool.previous, penTool.next );
            penTool.previous = penTool.next;
        };

        self._addTool( penTool );

        var clearAll = self._createToolBase({ id: 'clear_all', label: 'Clear All', img: 'default.png' });
        clearAll.activate = function () {
            var removables = [];
            for( var k in self.map.markers ) {
                var markerInfo = self.map.markers[ k ];
                if( markerInfo.model.mine ) { removables.push( markerInfo ); }
            }
            for( var i in removables ) {
                self.map.onRemoveMarker( removables[i].element );
            }
            self.activateTool( 'pan' );
        };
        self._addTool( clearAll );

        self.activateTool( 'pan' );
        return this.toolsContainer;
    },

    _createPlatoonControl: function( name ) {
        var platoonTool = this._createMarkerTool({
            id: 'platoon_' + name,
            label: name,
            img: 'default.png',
            unique: true
        });
        this._addTool( platoonTool );
        return platoonTool;
    },

    activateTool: function (id) {
        if( this.selectedTool && this.selectedTool.id === id ) { return; }
        if( this.selectedTool ) {
            this.selectedTool.button.removeClass( "active" );
            if( this.selectedTool.deactivate ) { this.selectedTool.deactivate(); }
        }

        this.selectedTool = this.tools[ id ];
        this.selectedTool.button.addClass( "active" );
        if( this.selectedTool.activate ) { this.selectedTool.activate(); }
    },

    _addTool: function ( tool ) {
        var id = tool.id;
        var self = this;
        this.tools[ id ] = tool;

        $( this.toolsContainer ).append( tool.button );
        tool.button.on('click', function () { self.activateTool( id ); });
        tool.button.on('mousedown', function () { return false; });
    },

    _createToolBase: function ( spec ) {
        var button = $(
            '<div class="button">' +
                '<img src="' + spec.img + '" />' +
                '<div>' + spec.label + '</div>' +
            '</div>');

        var tool = {
            id: spec.id,
            button: button,
            setIcon: function (url) { button.children('img').attr( "src", url ); tool.url = url; },
            setText: function (text) { button.children('div').text( text ); tool.text = text; }
        };

        return tool;
    },

    _createMarkerTool: function ( spec ) {
        var self = this;
        var tool = this._createToolBase( spec );

        var phase_down = function (e) {
            console.log( "Phase down" );
            tool.spec.start = e.latlng;
            tool.spec.path = [ e.latlng ];
            self.map.map.off( 'mousedown', phase_down );
            self.map.map.on( 'mouseup', phase_up );
        };

        var phase_up = function (e) {
            console.log( "Phase up" );
            self.map.map.off( 'mouseup', phase_up );

            tool.spec.path.push( e.latlng );
            var id = null;
            if( spec.unique ) { id = self.map.player.id + "-" + spec.id; }
            else { id = self.map.player.id + "-" + Date.now(); }

            var marker = new MarkerModel({
                id: id,
                player: self.map.player.id,
                location: tool.spec.start,
                unique: !!spec.unique,
                img: spec.img || 'default.png'
            });

            if( spec.unique ) {
                tool.marker = marker;
            }

            self.map.onUpdateMarker( marker );

            tool.activate();
        };

        tool.activate = function () {
            self.map.map.dragging.disable();
            tool.spec = { img: spec.img };
            self.map.map.on( 'mousedown', phase_down );
        };

        tool.deactivate = function () {
            self.map.map.dragging.enable();
            tool.spec = null;
            self.map.map.off( 'mousedown', phase_down );
            self.map.map.off( 'mouseup', phase_up );
        };

        var superSetIcon = tool.setIcon;
        tool.setIcon = function (url) {
            superSetIcon(url);
            spec.img = url;
            if( tool.marker ) {
                tool.marker.img = url;
                self.map.onUpdateMarker( tool.marker );
            }
        };

        return tool;
    }
});

module.exports = EditControls;
