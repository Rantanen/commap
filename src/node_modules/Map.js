
"use strict";

var MapMarker = require('MapMarker');
var MarkerModel = require('MarkerModel');
var EditControls = require('EditControls');

/*global $, L */

var setStatus = function(s) { $('#map-status').text(s); };

var Map = function ( model, loginCb ) {
    this.model = model;

    // Create the map.
    $('#map').remove();
    var mapElement = $('<div id="map">');
    $('#map-layer').append( mapElement );
    this.map = L.map('map', {
        minZoom: 0,
        maxZoom: 5,
        crs: L.CRS.Simple,
        zoomControl: false,
        maxBounds: L.latLngBounds([ 0, 0 ], [ -256, 256 ])
    }).setView([-128,128], 3);
    this.layerControls = L.control.layers( {}, {}, { collapsed: false }).addTo( this.map );

    // Initialize the members.
    this.playerOverlays = {};
    this.markers = {};

    // Initialize the map itself.
    this.createContinents( model.data.continents );

    for( var i in model.data.players ) {
        var player = model.data.players[i];
        this.updatePlayer( player );
    }

    var self = this;
    this.model.on( 'playerupdated', function (player) { self.updatePlayer( player ); } );
    this.model.on( 'markerupdated', function (marker) { self.updateMarker( marker ); } );
};

Map.prototype.setPlayer = function( player, server ) {
    this.player = player;
    this.server = server;

    // Create and add edit controls.
    if( !this.editControls )
        this.editControls = new EditControls( this ).addTo( this.map );
    else
        this.editControls.update();
}

Map.prototype.createContinents = function( continents ) {
    this.continents = {};

    for( var i in continents ) {
        var continent = continents[i];
        var layer = L.tileLayer( '/maps/' + continent + '/{z}/{x}/{y}.jpg', {
            tms: true,
            noWrap: true
        });

        if( !this.selectedContinent ) {
            this.selectedContinent = continent;
            layer.addTo( this.map );
        }

        this.layerControls.addBaseLayer( layer, continent );
        this.continents[ continent ] = layer;
    }
};

Map.prototype.updatePlayer = function( player ) {
    console.log("Update player");
    var self = this;
    var overlay = null;

    if( this.playerOverlays[ player.id ] ) {
        overlay = this.playerOverlays[ player.id ];
        overlay.eachLayer( function( marker ) {
            delete self.markers[ marker.id ];
        });
        overlay.clearLayers();
    }

    if( !overlay ) {
        overlay = L.layerGroup().addTo( this.map );
        if( this.player !== player )
            this.layerControls.addOverlay( overlay, player.info.name );
        this.playerOverlays[ player.id ] = overlay;
    } else {
        if( this.player === player )
            this.layerControls.removeLayer( overlay );
    }

    for( var m in player.markers ) 
    {
        var markerModel = player.markers[ m ];
        this.updateMarker( player.markers[ m ] );
    }
};

Map.prototype.updateMarker = function( model ) {
    var self = this;
    model.mine = ( this.player && model.player === this.player.id );

    var layer = this.playerOverlays[ model.player ];
    if( !layer ) return;

    var marker = null;
    if( this.markers[ model.id ] ) {

        marker = this.markers[ model.id ];
        marker.update( model );

    } else {

        marker = new MapMarker( model ).addTo( layer );
        marker.on('remove', function ( model ) { self.onRemoveMarker( model ); } );
        marker.on('moved', function ( data ) { self.server.updateMarker( data.model ); });
        this.markers[ model.id ] = marker;
    }
};

Map.prototype.onUpdateMarker = function( marker ) {
    this.model.updateMarker( marker );
    this.server.updateMarker( marker );
};

Map.prototype.onRemoveMarker = function( marker ) {
    this.server.removeMarker( marker.player, marker.id );
    this.removeMarker( marker.player, marker.id );
};

Map.prototype.onDraw = function( start, end ) {
    this.server.draw( start, end );
    this.draw( start, end );
};

Map.prototype.draw = function( start, end ) {
    var self = this;
    var polyline = L.polyline([ start, end ], { color: 'red', opacity: 1 }).addTo( this.map );
    setTimeout( function () {
        var opacity = 1;
        var interval = setInterval( function () {
            opacity = opacity - 0.25;
            if( opacity <= 0 ) {
                clearInterval( interval );
                self.map.removeLayer( polyline );
            } else {
                polyline.setStyle({ opacity: opacity });
            }
        }, 100 );
    }, 5000);
};

Map.prototype.removeMarker = function( owner, id ) {
    var marker = this.markers[ id ];
    var layer = this.playerOverlays[ owner ];
    layer.removeLayer( marker );
    delete this.markers[ id ]
};

Map.prototype.addMarker = function( marker ) {
};

module.exports = Map;
