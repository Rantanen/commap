
"use strict";

/*global $, alert */

var EventEmitter = require('events').EventEmitter;

var UserControls = function ( container, server, config ) {
    var self = this;
    this.server = server;
    this.config = config;

    container.empty();
    this.login = $('<form id="login" action="javascript:;">');
    var username = $('<input type="text" placeholder="Name">');
    var submit = $('<input type="submit" value="Enter">');
    this.login.append( '<span class="name-prompt">Enter your character name to take part in planning:</span>' );
    this.login.append( username, submit );
    container.append( this.login );

    this.userinfo = $('<div id="userinfo">');
    this.userinfo.hide();
    container.append( this.userinfo );

    this.login.submit( function () {
        self.logIn( username.val() );
    });

    var cookieName = $.cookie( 'name' );
    if( cookieName && false ) {
        this.logIn( cookieName );
    }
};
UserControls.extends( EventEmitter );

UserControls.prototype.logIn = function( name ) {
    var self = this;
    this.server.logIn( name, function( player, err ) { self.onLogIn( player, err ); } );
};

UserControls.prototype.onLogIn = function ( player, error ) {
    if( player ) {
        // Strip out everything but the player info.
        // UserControls should never touch markers.
        $.cookie( 'name', player.info.name, { expires: 7 } );
        this.login.hide();
        player.current = true;
        this.player = { id: player.id, info: player.info };
        this.emit( 'loggedIn', player );

        this._createUserInfo();
    }
};

UserControls.prototype._createUserInfo = function () {
    var self = this;
    var player = this.player;
    this.userinfo.empty();

    var username = $('<div class="username">').text( player.info.name );
    this.userinfo.append( this._createUserInfoSection( "Current user:", username ) );

    var outfit = $('<select class="outfit">');
    for( var k in this.config.outfits ) {
        var o = this.config.outfits[k];
        var name = o.name;
        if( o.tag ) { name = o.tag + ' - ' + name; }
        var oElement = $('<option value="' + k + '">').text( name );
        outfit.append( oElement );
    }
    outfit.change(function() {
        var value = $(this).val();
        self.player.info.outfit = self.config.outfits[ value ];
        self.emit( 'updated', player );
    });

    this.userinfo.append( this._createUserInfoSection( "Outfit:", outfit ) );

    this.userinfo.show();
};

UserControls.prototype._createUserInfoSection = function () {
    var section = $('<div class="section">');
    for( var i in arguments ) {
        var item = arguments[i];
        if( typeof( item ) === 'string' ) {
            section.append( $('<span class="label">').text( item ) );
        } else {
            section.append( item );
        }
    }
    return section;
};

module.exports = UserControls;
