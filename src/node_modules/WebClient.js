
"use strict";

/*global $, alert */

var MapModel = require('MapModel');
var MarkerModel = require('MarkerModel');
var UserControls = require('UserControls');

if( environment === 'client') {
    var Map = require('Map');
}

var WebClient = function () {
    var self = this;
    this.players = {};
};

WebClient.prototype.connected = function (server, mapData, config) {
    var self = this;
    this.server = server;

    this.model = new MapModel( mapData );
    this.map = new Map( this.model );

    this.userControls = new UserControls( $('#header'), server, config );
    this.userControls.on( 'loggedIn', function ( player ) {
        self.map.setPlayer( player, server );
        self.model.updatePlayer( player );
    });

    this.userControls.on( 'updated', function ( player ) {
        self.map.setPlayer( player, server );
        self.model.updatePlayer( player );
        server.updatePlayer({
            id: player.id,
            info: player.info
        });
    });
};

WebClient.prototype.updatePlayer = function ( server, player ) {
    this.model.updatePlayer( player );
    if( this.map.player && this.map.player.id === player.id ) this.map.setPlayer( player, server );
};

WebClient.prototype.updateMarker = function ( server, marker ) {
    console.log( "Received marker update: " + marker.id );
    this.model.updateMarker( new MarkerModel( marker ));
};

WebClient.prototype.removeMarker = function ( server, owner, markerId ) {
    this.map.removeMarker( owner, markerId );
};

WebClient.prototype.draw = function ( server, start, end ) {
    this.map.draw( start, end );
};

module.exports = WebClient;
