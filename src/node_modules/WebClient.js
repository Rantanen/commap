
"use strict";

/*global $, alert */

var MapModel = require('MapModel');
var MarkerModel = require('MarkerModel');
var UserControls = require('UserControls');

if( environment === 'client') {
    var CommandMap = require('CommandMap');
}

var WebClient = function () {
    var self = this;
    this.players = {};
};

WebClient.prototype.connected = function (server, mapData, config) {
    var self = this;
    this.server = server;

    this.model = new MapModel( mapData );
    this.map = new CommandMap( this.model );

    this.userControls = new UserControls( $('#usercontrols'), server, config );
    this.userControls.on( 'loggedIn', function ( player ) {
        self.map.setPlayer( player, server );
        self.model.updatePlayer( player );
    });

    this.userControls.on( 'updated', function ( player ) {
        self.map.setPlayer( player, server );
        self.model.updatePlayer( player );
        server.updatePlayer({
            id: player.id,
            info: player.info
        });
    });

    this._startPing( server );
};

WebClient.prototype.updatePlayer = function ( server, player ) {
    this.model.updatePlayer( player );
    if( this.map.player && this.map.player.id === player.id ) {
        this.map.setPlayer( player, server );
    }
};

WebClient.prototype.removePlayer = function ( server, player ) {
    this.model.removePlayer( player );
    if( this.map.player && this.map.player.id === player.id ) {
        this.map.setPlayer( null, server );
    }
};

WebClient.prototype.updateMarker = function ( server, marker ) {
    this.model.updateMarker( new MarkerModel( marker ));
};

WebClient.prototype.removeMarker = function ( server, owner, markerId ) {
    this.model.removeMarker( owner, markerId );
};

WebClient.prototype.suggestTarget = function ( server, markerId, target, playerName ) {
    this.map.suggestTarget( markerId, target, playerName );
};

WebClient.prototype.rejectSuggestion = function ( server, markerId, playerName ) {
    this.map.rejectSuggestion( markerId, playerName );
};

WebClient.prototype.draw = function ( server, start, end ) {
    this.map.draw( start, end );
};

WebClient.prototype._startPing = function ( server ) {
    if( this.pingInterval ) { clearInterval( this.pingInterval ); }

    this.pingInterval = setInterval( function () {
        server.ping();
    }, 2000);
};

module.exports = WebClient;
