
"use strict";

var MapModel = require('MapModel');
var MarkerModel = require('MarkerModel');

if( environment === 'client') {
    var Map = require('Map');
}

/*global $, alert */

var WebClient = function () {
    var self = this;
    $('#login').submit( function () {
        self.server.logIn(
            $('#login input[name=name]').val(),
            function( player, err ) { self._logIn( player, err ); }
        );
    });
};

WebClient.prototype.connected = function (server, mapData) {
    var self = this;
    this.server = server;
    this.mapModel = new MapModel( mapData );
    this.map = new Map( this.mapModel );

    // var name = $.cookie( 'name' )
    var name = null;
    if( name ) {
        $.cookie( 'name', name, { expires: 7 } );
        self.server.logIn( name, function( player, err ) { self._logIn( player, err ); } );
    }
};

WebClient.prototype.updatePlayer = function ( server, player ) {
    this.mapModel.updatePlayer( player );
};

WebClient.prototype.updateMarker = function ( server, marker ) {
    console.log( "Received marker update: " + marker.id );
    this.map.updateMarker( new MarkerModel( marker ));
};

WebClient.prototype.removeMarker = function ( server, owner, markerId ) {
    this.map.removeMarker( owner, markerId );
};

WebClient.prototype._logIn = function ( player, error ) {
    if( player ) {
        $('#login').hide();
        player.current = true;
        this.map.setPlayer( player, this.server );
        this.mapModel.updatePlayer( player );
    }
};

module.exports = WebClient;
